generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                 @id @default(cuid())
  name                String?
  email               String                 @unique
  emailVerified       DateTime?
  image               String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  accounts            Account[]
  messages            Message[]
  sessions            Session[]
  organizations       Organization[]         @relation("OrganizationMembers")
  uploadedDocuments   OrganizationDocument[]
  assignedChats       Chat[]                 @relation("AssignedChats")
  requestedTickets    Ticket[]               @relation("TicketRequester")
  assignedTickets     Ticket[]               @relation("TicketAssignee")
  ticketResponses     TicketResponse[]
  ticketActivities    TicketActivity[]
  uploadedAttachments TicketAttachment[]
  createdForms        SupportForm[]          @relation("FormCreator")
}

model Organization {
  id          String                 @id @default(cuid())
  name        String
  description String?
  slug        String                 @unique
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  chatbots    Chatbot[]
  users       User[]                 @relation("OrganizationMembers")
  documents   OrganizationDocument[]
  tickets     Ticket[]
  supportForms SupportForm[]

  @@index([slug])
}

model OrganizationDocument {
  id             String                   @id @default(cuid())
  title          String
  content        String
  type           OrganizationDocumentType @default(TEXT)
  metadata       Json?
  vectorId       String?                  @unique // Reference to vector in external vector DB
  organizationId String
  uploadedBy     String
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  organization   Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader       User                     @relation(fields: [uploadedBy], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([vectorId])
  @@index([uploadedBy])
}

model Chatbot {
  id             String         @id @default(cuid())
  name           String
  description    String?
  status         ChatbotStatus  @default(ACTIVE)
  config         Json?
  organizationId String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  chats          Chat[]
  contextBlocks  ContextBlock[]
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
}

model ContextBlock {
  id        String           @id @default(cuid())
  title     String
  content   String
  type      ContextBlockType @default(TEXT)
  metadata  Json?
  vectorId  String?          @unique // Reference to vector in external vector DB
  chatbotId String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  chatbot   Chatbot          @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([chatbotId])
  @@index([type])
  @@index([vectorId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Chat {
  id                    String     @id @default(cuid())
  title                 String
  description           String?
  status                ChatStatus @default(ACTIVE)
  escalationRequested   Boolean    @default(false)
  escalationReason      String?
  escalationRequestedAt DateTime?
  assignedToId          String?
  assignedAt            DateTime?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  chatbotId             String?
  chatbot               Chatbot?   @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  messages              Message[]
  assignedTo            User?      @relation("AssignedChats", fields: [assignedToId], references: [id])
  tickets               Ticket[]

  @@index([chatbotId])
  @@index([status])
  @@index([createdAt])
  @@index([escalationRequested])
  @@index([assignedToId])
}

model Message {
  id        String      @id @default(cuid())
  content   String
  role      MessageRole
  metadata  Json?
  chatId    String
  userId    String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  chat      Chat        @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user      User?       @relation(fields: [userId], references: [id])

  @@index([chatId])
  @@index([createdAt])
}

enum ChatStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum MessageRole {
  USER
  ASSISTANT
  AGENT
  SYSTEM
}

enum ChatbotStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ContextBlockType {
  TEXT
  CODE
  DOCUMENTATION
  FAQ
  TROUBLESHOOTING
  TUTORIAL
}

enum OrganizationDocumentType {
  TEXT
  POLICY
  PROCEDURE
  MANUAL
  GUIDE
  FAQ
  ANNOUNCEMENT
}

// Support Ticket Models

model Ticket {
  id           String         @id @default(cuid())
  ticketNumber Int            @unique @default(autoincrement())
  subject      String
  description  String
  status       TicketStatus   @default(NEW)
  priority     TicketPriority @default(MEDIUM)
  category     String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  requesterId    String?
  requester      User?   @relation("TicketRequester", fields: [requesterId], references: [id])
  requesterEmail String
  requesterName  String

  assignedToId String?
  assignedTo   User?     @relation("TicketAssignee", fields: [assignedToId], references: [id])
  assignedAt   DateTime?

  // Chat Integration
  originChatId  String?
  originChat    Chat?    @relation(fields: [originChatId], references: [id])
  linkedChatIds String[] @default([])

  // Form Integration
  originFormId String?
  originForm   SupportForm? @relation("FormTickets", fields: [originFormId], references: [id])

  // Metadata
  tags         String[] @default([])
  customFields Json?
  metadata     Json?

  // SLA tracking
  firstResponseAt  DateTime?
  firstResponseSla DateTime?
  resolutionSla    DateTime?
  resolvedAt       DateTime?
  closedAt         DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  responses   TicketResponse[]
  attachments TicketAttachment[]
  activities  TicketActivity[]

  @@index([organizationId])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([requesterId])
  @@index([requesterEmail])
  @@index([createdAt])
  @@index([ticketNumber])
  @@index([originChatId])
  @@index([originFormId])
}

model TicketResponse {
  id             String  @id @default(cuid())
  content        String
  isInternal     Boolean @default(false)
  isEmailSent    Boolean @default(false)
  emailMessageId String?

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId    String?
  author      User?              @relation(fields: [authorId], references: [id])
  authorEmail String
  authorName  String
  authorType  ResponseAuthorType @default(AGENT)

  attachments TicketAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
}

model TicketAttachment {
  id           String  @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  thumbnailUrl String?

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  responseId String?
  response   TicketResponse? @relation(fields: [responseId], references: [id], onDelete: Cascade)

  uploadedById String?
  uploadedBy   User?   @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([responseId])
  @@index([uploadedById])
}

model TicketActivity {
  id       String @id @default(cuid())
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  activityType TicketActivityType
  description  String
  changes      Json?

  performedById   String?
  performedBy     User?   @relation(fields: [performedById], references: [id])
  performedByName String

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([createdAt])
}

// Ticket Enums

enum TicketStatus {
  NEW
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  WAITING_ON_THIRD_PARTY
  RESOLVED
  CLOSED
  CANCELLED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
  CRITICAL
}

enum ResponseAuthorType {
  CUSTOMER
  AGENT
  SYSTEM
  EMAIL
}

enum TicketActivityType {
  CREATED
  STATUS_CHANGED
  PRIORITY_CHANGED
  ASSIGNED
  UNASSIGNED
  RESPONDED
  INTERNAL_NOTE_ADDED
  ATTACHMENT_ADDED
  TAG_ADDED
  TAG_REMOVED
  MERGED
  SPLIT
  REOPENED
  RESOLVED
  CLOSED
}

// Support Form Models

model SupportForm {
  id             String            @id @default(cuid())
  name           String
  description    String?
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Form Configuration (stored as JSON for flexibility)
  fields         Json              // Array of field definitions
  settings       Json              // Form settings (theme, validation, redirects, etc.)
  defaultValues  Json?             // Default values for auto-populated fields

  // Status & Metadata
  status         SupportFormStatus @default(ACTIVE)
  isPublic       Boolean           @default(true) // Can be accessed via public URL
  embedCode      String            @unique // Short code for embedding (e.g., "abc123")

  // Assignment & Routing
  defaultCategory String?          // Default category for tickets from this form
  defaultPriority TicketPriority? // Default priority
  autoAssignToId  String?          // Auto-assign tickets to specific agent
  tags            String[]         @default([]) // Auto-tag tickets from this form

  // Analytics
  submissionCount Int              @default(0) // Track submissions (for analytics)
  lastSubmittedAt DateTime?

  // Timestamps
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  createdById    String
  createdBy      User              @relation("FormCreator", fields: [createdById], references: [id])

  // Relations
  ticketsFromForm Ticket[] @relation("FormTickets")

  @@index([organizationId])
  @@index([embedCode])
  @@index([status])
  @@index([isPublic])
}

enum SupportFormStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}
